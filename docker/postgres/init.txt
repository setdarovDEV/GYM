\c gym_delivery;

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

CREATE TABLE IF NOT EXISTS users (
    id BIGSERIAL PRIMARY KEY,
    telegram_id BIGINT UNIQUE NOT NULL,
    username VARCHAR(255),
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    language_code VARCHAR(10),
    language VARCHAR(10) DEFAULT 'ru',
    phone_number VARCHAR(20),
    is_active BOOLEAN DEFAULT TRUE,
    is_admin BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_users_telegram_id ON users(telegram_id);
CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
CREATE INDEX IF NOT EXISTS idx_users_language ON users(language);
CREATE INDEX IF NOT EXISTS idx_users_is_active ON users(is_active);

CREATE TABLE IF NOT EXISTS categories (
    id BIGSERIAL PRIMARY KEY,
    name_ru VARCHAR(255) NOT NULL,
    name_uz VARCHAR(255) NOT NULL,
    name_en VARCHAR(255) NOT NULL,
    description_ru TEXT,
    description_uz TEXT,
    description_en TEXT,
    image_url VARCHAR(500),
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS products (
    id BIGSERIAL PRIMARY KEY,
    category_id BIGINT REFERENCES categories(id) ON DELETE SET NULL,
    name_ru VARCHAR(255) NOT NULL,
    name_uz VARCHAR(255) NOT NULL,
    name_en VARCHAR(255) NOT NULL,
    description_ru TEXT,
    description_uz TEXT,
    description_en TEXT,
    price INTEGER NOT NULL CHECK (price >= 0),
    image_url VARCHAR(500),
    weight_grams INTEGER,
    protein INTEGER,
    carbs INTEGER,
    fats INTEGER,
    calories INTEGER,
    is_available BOOLEAN DEFAULT TRUE,
    is_popular BOOLEAN DEFAULT FALSE,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_products_category_id ON products(category_id);
CREATE INDEX IF NOT EXISTS idx_products_is_available ON products(is_available);
CREATE INDEX IF NOT EXISTS idx_products_price ON products(price);

CREATE TABLE IF NOT EXISTS cart_items (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    quantity INTEGER DEFAULT 1 CHECK (quantity > 0),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, product_id)
);

CREATE TABLE IF NOT EXISTS orders (
    id BIGSERIAL PRIMARY KEY,
    order_number VARCHAR(50) UNIQUE NOT NULL DEFAULT 'GD-' || LPAD(nextval('orders_id_seq'::regclass)::text, 6, '0'),
    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
    total_amount INTEGER NOT NULL CHECK (total_amount >= 0),
    delivery_fee INTEGER DEFAULT 15000,
    delivery_address TEXT,
    customer_name VARCHAR(255),
    customer_phone VARCHAR(20),
    status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'preparing', 'ready', 'delivering', 'delivered', 'cancelled')),
    payment_method VARCHAR(50) DEFAULT 'cash' CHECK (payment_method IN ('cash', 'card', 'online')),
    payment_status VARCHAR(50) DEFAULT 'unpaid' CHECK (payment_status IN ('unpaid', 'paid', 'refunded')),
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_orders_user_id ON orders(user_id);
CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
CREATE INDEX IF NOT EXISTS idx_orders_created_at ON orders(created_at);

CREATE TABLE IF NOT EXISTS order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES orders(id) ON DELETE CASCADE,
    product_id BIGINT REFERENCES products(id) ON DELETE SET NULL,
    product_name_ru VARCHAR(255),
    product_name_uz VARCHAR(255),
    product_name_en VARCHAR(255),
    price INTEGER NOT NULL CHECK (price >= 0),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    total INTEGER NOT NULL CHECK (total >= 0),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS settings (
    id BIGSERIAL PRIMARY KEY,
    key VARCHAR(100) UNIQUE NOT NULL,
    value TEXT,
    description TEXT,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);


INSERT INTO settings (key, value, description) VALUES
    ('delivery_fee', '15000', '–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Ç–∏–π–∏–Ω–∞—Ö'),
    ('min_order_amount', '50000', '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –≤ —Ç–∏–π–∏–Ω–∞—Ö'),
    ('free_delivery_amount', '200000', '–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Ç–∏–π–∏–Ω–∞—Ö'),
    ('contact_phone', '+998901234567', '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω'),
    ('contact_address', '–¢–∞—à–∫–µ–Ω—Ç, –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω', '–ê–¥—Ä–µ—Å'),
    ('working_hours', '09:00-22:00', '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã')
ON CONFLICT (key) DO NOTHING;

INSERT INTO categories (name_ru, name_uz, name_en, description_ru, sort_order) VALUES
    ('–ü—Ä–æ—Ç–µ–∏–Ω', 'Protein', 'Protein', '–ü—Ä–æ—Ç–µ–∏–Ω–æ–≤—ã–µ –¥–æ–±–∞–≤–∫–∏ –¥–ª—è —Ä–æ—Å—Ç–∞ –º—ã—à—Ü', 1),
    ('–ì–µ–π–Ω–µ—Ä', 'Gejner', 'Gainer', '–í—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω—ã–µ –¥–æ–±–∞–≤–∫–∏ –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã', 2),
    ('–ö—Ä–µ–∞—Ç–∏–Ω', 'Kreatin', 'Creatine', '–ö—Ä–µ–∞—Ç–∏–Ω –¥–ª—è —Å–∏–ª—ã –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏', 3),
    ('–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã', 'Aminokislotalar', 'Amino Acids', 'BCAA –∏ –¥—Ä—É–≥–∏–µ –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã', 4),
    ('–í–∏—Ç–∞–º–∏–Ω—ã', 'Vitaminlar', 'Vitamins', '–í–∏—Ç–∞–º–∏–Ω—ã –∏ –º–∏–Ω–µ—Ä–∞–ª—ã', 5)
ON CONFLICT DO NOTHING;

INSERT INTO products (category_id, name_ru, name_uz, name_en, description_ru, price, is_available, is_popular) VALUES
    (1, '–ü—Ä–æ—Ç–µ–∏–Ω Whey Gold', 'Whey Gold Protein', 'Whey Gold Protein', '–°—ã–≤–æ—Ä–æ—Ç–æ—á–Ω—ã–π –ø—Ä–æ—Ç–µ–∏–Ω –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞', 150000, true, true),
    (1, '–ü—Ä–æ—Ç–µ–∏–Ω Casein', 'Kazein Proteini', 'Casein Protein', '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–µ–∏–Ω –Ω–∞ –Ω–æ—á—å', 140000, true, false),
    (2, '–ì–µ–π–Ω–µ—Ä Serious Mass', 'Serious Mass Gejner', 'Serious Mass Gainer', '–í—ã—Å–æ–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω—ã–π –≥–µ–π–Ω–µ—Ä –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã', 180000, true, true),
    (3, '–ö—Ä–µ–∞—Ç–∏–Ω –º–æ–Ω–æ–≥–∏–¥—Ä–∞—Ç', 'Kreatin Monogidrat', 'Creatine Monohydrate', '–ß–∏—Å—Ç—ã–π –∫—Ä–µ–∞—Ç–∏–Ω –¥–ª—è —Å–∏–ª—ã', 80000, true, true),
    (4, 'BCAA 2:1:1', 'BCAA 2:1:1', 'BCAA 2:1:1', '–ê–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è', 120000, true, false),
    (5, '–ú—É–ª—å—Ç–∏–≤–∏—Ç–∞–º–∏–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å', 'Multivitamin Kompleksi', 'Multivitamin Complex', '–ö–æ–º–ø–ª–µ–∫—Å –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤', 90000, true, true)
ON CONFLICT DO NOTHING;

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_products_updated_at BEFORE UPDATE ON products
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_cart_items_updated_at BEFORE UPDATE ON cart_items
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_orders_updated_at BEFORE UPDATE ON orders
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TABLE IF NOT EXISTS audit_log (
    id BIGSERIAL PRIMARY KEY,
    table_name VARCHAR(100) NOT NULL,
    record_id BIGINT,
    operation VARCHAR(20) NOT NULL,
    old_data JSONB,
    new_data JSONB,
    user_id BIGINT,
    ip_address INET,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS statistics (
    id BIGSERIAL PRIMARY KEY,
    metric_date DATE NOT NULL,
    total_users INTEGER DEFAULT 0,
    new_users INTEGER DEFAULT 0,
    total_orders INTEGER DEFAULT 0,
    completed_orders INTEGER DEFAULT 0,
    total_revenue BIGINT DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,    UNIQUE(metric_date)
);

GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO postgres;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO postgres;

DO $$
BEGIN
    RAISE NOTICE '‚úÖ Database initialization completed successfully!';
    RAISE NOTICE 'üìä Tables created: users, categories, products, cart_items, orders, order_items, settings, audit_log, statistics';
    RAISE NOTICE 'üìù Test data inserted: 5 categories, 6 products, 6 settings';
    RAISE NOTICE 'üöÄ Ready to use!';
END $$;